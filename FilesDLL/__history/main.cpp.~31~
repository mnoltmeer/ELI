#include <vcl.h>
#include <windows.h>

#pragma hdrstop
#pragma argsused

#include "..\MyFunc.h"

#include "eli_interface.h"

String initdir;

extern "C"
{
__declspec(dllexport) void __stdcall eIsFileExist(void *p)
{
  ELI_INTERFACE *ep = (ELI_INTERFACE*)p;
  wchar_t res[3];

  String path = ep->GetParamToStr(L"pFile");

  //использован путь типа ".\file.eli" - используется текущий каталог
  if (path[1] == '.')
	{
	  path.Delete(1, 1);
	  path = std::wstring(GetInitDir()) + path;
	}

  try
	 {
	   int i = FileExists();
	   swprintf(res, L"%d", i);
	 }
  catch (Exception &e)
	 {
	   swprintf(res, L"%d", -1);
	 }

  ep->SetFunctionResult(ep->GetCurrentFuncName(), res);
}
//-------------------------------------------------------------------------------

__declspec(dllexport) void __stdcall eCopyFile(void *p)
{
  ELI_INTERFACE *ep = (ELI_INTERFACE*)p;

  wchar_t res[3];

  try
	 {
	   int i = CopyFile(ep->GetParamToStr(L"pFrom"),
						ep->GetParamToStr(L"pTo"),
						bool(ep->GetParamToInt(L"pFailExist")));
	   swprintf(res, L"%d", i);
	 }
  catch (Exception &e)
	 {
	   swprintf(res, L"%d", -1);
	 }

  ep->SetFunctionResult(ep->GetCurrentFuncName(), res);
}
//-------------------------------------------------------------------------------

__declspec(dllexport) void __stdcall eDeleteFile(void *p)
{
  ELI_INTERFACE *ep = (ELI_INTERFACE*)p;

  wchar_t res[3];

  try
	 {
	   int i = DeleteFile(ep->GetParamToStr(L"pFile"));
	   swprintf(res, L"%d", i);
	 }
  catch (Exception &e)
	 {
	   swprintf(res, L"%d", -1);
	 }

  ep->SetFunctionResult(ep->GetCurrentFuncName(), res);
}
//-------------------------------------------------------------------------------

__declspec(dllexport) void __stdcall eReadTextFile(void *p)
{
  ELI_INTERFACE *ep = (ELI_INTERFACE*)p;

  String res;

  try
	 {
	   res = LoadTextFile(ep->GetParamToStr(L"pFile"));
	 }
  catch (Exception &e)
	 {
	   res = "";
	 }

  ep->SetFunctionResult(ep->GetCurrentFuncName(), res.c_str());
}
//-------------------------------------------------------------------------------

__declspec(dllexport) void __stdcall eWriteTextFile(void *p)
{
  ELI_INTERFACE *ep = (ELI_INTERFACE*)p;

  String res;

  try
	 {
	   String mode = ep->GetParamToStr(L"pMode");

	   if (mode == "ap")
		 {
		   AddToFile(ep->GetParamToStr(L"pFile"), ep->GetParamToStr(L"pText"));
		   res = "1";
		 }
	   else if (mode == "ow")
		 {
		   SaveToFile(ep->GetParamToStr(L"pFile"), ep->GetParamToStr(L"pText"));
		   res = "1";
		 }
	   else
		 {
           res = 0;
         }
	 }
  catch (Exception &e)
	 {
	   res = "-1";
	 }

  ep->SetFunctionResult(ep->GetCurrentFuncName(), res.c_str());
}
//-------------------------------------------------------------------------------

__declspec(dllexport) void __stdcall eFileSize(void *p)
{
  ELI_INTERFACE *ep = (ELI_INTERFACE*)p;

  wchar_t res[3];

  try
	 {
	   int sz = GetFileSize(ep->GetParamToStr(L"pFile"));
       swprintf(res, L"%d", sz);
	 }
  catch (Exception &e)
	 {
	   swprintf(res, L"%d", -1);
	 }

  ep->SetFunctionResult(ep->GetCurrentFuncName(), res);
}
//-------------------------------------------------------------------------------

__declspec(dllexport) void __stdcall eCopyDir(void *p)
{
  ELI_INTERFACE *ep = (ELI_INTERFACE*)p;

  wchar_t res[3];

  try
	 {
	   int i = CopyDirs(ep->GetParamToStr(L"pDirSrc"),
						ep->GetParamToStr(L"pDirDest"));
       swprintf(res, L"%d", i);
	 }
  catch (Exception &e)
	 {
	   swprintf(res, L"%d", -1);
	 }

  ep->SetFunctionResult(ep->GetCurrentFuncName(), res);
}
//-------------------------------------------------------------------------------

__declspec(dllexport) void __stdcall eClearDir(void *p)
{
  ELI_INTERFACE *ep = (ELI_INTERFACE*)p;

  wchar_t res[3];

  try
	 {
	   DeleteAllFromDir(ep->GetParamToStr(L"pDir"));
       swprintf(res, L"%d", 1);
	 }
  catch (Exception &e)
	 {
	   swprintf(res, L"%d", -1);
	 }

  ep->SetFunctionResult(ep->GetCurrentFuncName(), res);
}
//-------------------------------------------------------------------------------

__declspec(dllexport) void __stdcall eReadBinFile(void *p)
{
  ELI_INTERFACE *ep = (ELI_INTERFACE*)p;

  wchar_t res[3];

  try
	 {
	   //int i = DeleteFile(ep->GetParamToStr(L"pFile"));
	   swprintf(res, L"%d", 1);
	 }
  catch (Exception &e)
	 {
	   swprintf(res, L"%d", -1);
	 }

  ep->SetFunctionResult(ep->GetCurrentFuncName(), res);
}
//-------------------------------------------------------------------------------

}

int WINAPI DllEntryPoint(HINSTANCE hinst, unsigned long reason, void* lpReserved)
{
	return 1;
}

